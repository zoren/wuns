[defn wat-to-exports [wat-text import-object]
  [let [wasm-module-buffer [text-to-wasm wat-text]
        wasm-module [module-from-buffer wasm-module-buffer]
        wasm-instance [instantiate-module wasm-module import-object]
        exports [getq wasm-instance exports]]
    exports]]

[def tests
  [list
    [kv-map
      module [quote [[defn f [] [i32.const 5]]]]
      expect [quote [eq-form [f] [quote 5]]]]
    [kv-map
      module [quote [[defn f [] [i32.const 5] [i32.const 6]]]]
      expect [quote [eq-form [f] [quote 6]]]]
    [kv-map
      module [quote [[defn f [p] p]]]
      expect [quote [eq-form [f 1] [quote 1]]]]
    [kv-map
      module [quote [[defn inc [p] [i32.add [i32.const 1] p]]]]
      expect [quote [eq-form [inc 1] [quote 2]]]]
    [kv-map
      module [quote [import env mem [memory 0]]
                    [defn f [] [quote 5]]]
      import-object [kv-map env [kv-map mem [wasm-memory [kv-map initial 1]]]]
      expect [quote [eq-form [f] [quote 0]]]]
    [kv-map
      module [quote [import env mem [memory 0]]
                    [defn f [] [quote 5] [quote 5]]]
      import-object [kv-map env [kv-map mem [wasm-memory [kv-map initial 1]]]]
      expect [quote [eq-form [f] [quote 0]]]]

      ]]


[defn test-main []
  [for-each test tests
    [let
      [module [getq test module]
       expect [getq test expect]
       text [compile-top-forms-to-text module]
       import-object [if [hasq test import-object] [getq test import-object] [kv-map]]
       exports [wat-to-exports text import-object]
       export-names [keys exports]
       args [mutable-list]
       -
       [for-each export-name export-names
        [push args [get exports export-name]]]
       wrap-func [list [quote func] [quote wrapper] export-names expect]
       ]
    [if [eval [concat [list wrap-func] args]]
      [log [list [quote test] [quote pass]]]
      [log [list [quote test] [quote fail] expect]]]]]]
