[load translator.wuns]

[defn eq-int-list [expected actual]
  [and [eq [size expected] [size actual]]
    [[func go [i]
      [if [lt-s i [size expected]]
        [if [eq [at expected i] [at actual i]]
          [go [inc i]]
          0]
        1]] 0]]]

[type test-assert []
  [union
    [eq [list i32] word [list i32]]]]

[type test []
  [record
    [asserts [list test-assert]]
    [module [list form]]]]

[defn run-test [test-data]
  [let-do [instance [translate-to-wat [test/module test-data]]]
    [for-each a [test/asserts test-data]
      [match a
        [test-assert/eq expected func-name args]
        [let [actual [wasm-call-export instance func-name args]]
          [when-not [eq-int-list expected actual]
            [logq test failed]
            [log expected]
            [log actual]]]]]]]

[def tests
  [list
    [test
      [list [test-assert/eq [list] [word f] [list]]]
      [list
        [quote [def f [func f [] [do]]]]]]
    [test
      [list [test-assert/eq [list] [word g] [list]]]
      [list
        [quote [def g [func internal-name [] [do]]]]]]
    [test
      [list [test-assert/eq [list [i32 5]] [word f] [list]]]
      [list
        [quote [def f [func internal-name [] [i32 5]]]]]]
]]

[for-each t tests
  [run-test t]]
